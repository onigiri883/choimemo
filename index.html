<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>„Çπ„Éû„Éõ„É°„É¢Ôºà„Çø„ÉñÂêç„Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜÂØæÂøúÔºâ</title>
<style>
  :root{
    --bg:#f0f7ff; --card:#fff; --chip:#f6f9ff; --accent:#4b9cff; --muted:#6e6e6e;
    --icon-size:18px;
    font-family: -apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",Meiryo,Segoe UI, Roboto, "Noto Sans JP", sans-serif;
  }
  html,body{height:100%;margin:0;background:var(--bg);} 
  .phone{max-width:420px;margin:18px auto;padding:18px;background:var(--card);border-radius:22px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:80vh;display:flex;flex-direction:column}
  header{display:flex;align-items:center;gap:8px;padding-bottom:10px}
  .chip-row{display:flex;gap:8px;overflow:auto;padding:6px 4px; -webkit-overflow-scrolling:touch}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:16px;background:var(--chip);white-space:nowrap;font-size:14px}
  .chip.selected{background:var(--accent);color:#fff}
  .chip .label{padding:0 4px}
  .chip input.tab-edit{font-size:14px;padding:4px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);}
  .chip button{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center}
  .add-tag{background:transparent;color:var(--muted);border:1px dashed rgba(0,0,0,0.04);padding:6px 10px;border-radius:12px}
  .main{flex:1;overflow:auto;padding:6px 2px;-webkit-overflow-scrolling:touch}
  .box-card{margin:12px 6px 0 6px;border-radius:8px}
  .toolbar{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.03);border-radius:12px}
  .icon-btn{border:0;background:#fff;padding:6px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);font-size:14px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .small-icon{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;padding:0}
  .toolbar .char-count{margin-left:auto;padding:6px 10px;border-radius:999px;background:transparent;color:var(--muted);font-size:13px}
  textarea{width:100%;border:2px solid #000000;box-sizing:border-box;border-radius:6px;padding:10px 12px;margin-top:8px;font-size:15px;line-height:1.6;resize:none;overflow:hidden;background:#fff;min-height:48px}
  .top-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
  .meta{font-size:12px;color:var(--muted);padding-left:6px}
  @media (max-width:420px){.phone{margin:8px;border-radius:18px;padding:12px}textarea{min-height:64px}}
  .svg-icon{width:var(--icon-size);height:var(--icon-size);display:inline-block;vertical-align:middle}
</style>
</head>
<body>
  <div class="phone" role="application" aria-label="„É°„É¢„Ç¢„Éó„É™">
    <header>
      <div style="font-weight:700;font-size:18px">„É°„É¢</div>
      <div class="top-actions">
        <div class="meta" id="savedMeta">Ëá™Âãï‰øùÂ≠ò: ‚Äî</div>
      </div>
    </header>

    <div class="chip-row" id="tagBar" aria-label="„Çø„Éñ‰∏ÄË¶ß"></div>

    <div class="main" id="mainArea"></div>

  </div>

<script>
(function(){
  const STORAGE_KEY = 'mobile_memo_app_tab_inline_edit_v1';
  const saveMetaEl = document.getElementById('savedMeta');
  let state = null;
  const debounce = (fn, ms=700)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
  const uid = (n=8)=>Math.random().toString(36).slice(2,2+n);
  const nowStr = ()=>new Date().toLocaleString();

  function defaultState(){ return { tabs: [ { id: uid(), name: '„Éé„Éº„Éà', boxes: [ {id: uid(), content: ''} ] } ], activeTabId: null }; }

  function load(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) { state = defaultState(); state.activeTabId = state.tabs[0].id; return; } state = JSON.parse(raw); if(!state || !state.tabs || state.tabs.length===0) state = defaultState(); if(!state.activeTabId) state.activeTabId = state.tabs[0].id;}catch(e){ console.error('load error', e); state = defaultState(); } }

  function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); saveMetaEl.textContent = 'Ëá™Âãï‰øùÂ≠ò: ' + nowStr(); }catch(e){ console.error('save error', e); } }
  const saveDebounced = debounce(()=>save());

  const tagBar = document.getElementById('tagBar');
  const mainArea = document.getElementById('mainArea');

  // emoji icons
  function iconCopy(){ return 'üìã'; }
  function iconTrash(){ return 'üóëÔ∏è'; }
  function iconX(){ return '‚úñÔ∏è'; }
  function iconPlus(){ return '‚ûï'; }
  function iconClear(){ return 'üßΩ'; }
  function iconEraser(){ return 'üßΩ'; }
  function iconEdit(){ return '‚úèÔ∏è'; }

  function adjustHeight(el){ if(!el) return; el.style.height='auto'; const extra = 12; el.style.height = (el.scrollHeight + extra) + 'px'; }

  function startInlineEdit(chipEl, tab){
    const label = chipEl.querySelector('.label');
    // create input
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'tab-edit';
    input.value = tab.name;
    chipEl.insertBefore(input, label);
    chipEl.removeChild(label);
    input.focus();
    // move cursor to end
    input.setSelectionRange(input.value.length, input.value.length);
    const commit = ()=>{
      const v = input.value.trim() || '„Éé„Éº„Éà';
      tab.name = v;
      saveDebounced();
      // restore label
      const newLabel = document.createElement('span'); newLabel.className='label'; newLabel.textContent = tab.name;
      chipEl.insertBefore(newLabel, input);
      chipEl.removeChild(input);
      renderTags();
    };
    input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ commit(); } else if(e.key === 'Escape'){ renderTags(); } });
    input.addEventListener('blur', ()=>{ commit(); });
  }

  function renderTags(){
    tagBar.innerHTML = '';
    state.tabs.forEach(tab=>{
      const chip = document.createElement('div'); chip.className = 'chip' + (tab.id===state.activeTabId?' selected':''); chip.dataset.id = tab.id;
      const label = document.createElement('span'); label.className='label'; label.textContent = tab.name; chip.appendChild(label);

      chip.addEventListener('click', ()=>{ if(state.activeTabId === tab.id) return; state.activeTabId = tab.id; saveDebounced(); render(); });

      // copy-all
      const copyAllBtn = document.createElement('button'); copyAllBtn.className='icon-btn'; copyAllBtn.title='„Çø„ÉñÂÜÖ„Çí„Åæ„Å®„ÇÅ„Å¶„Ç≥„Éî„Éº'; copyAllBtn.innerHTML = iconCopy();
      copyAllBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); copyAllBoxes(tab.id); }); chip.appendChild(copyAllBtn);

      // edit inline
      const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='„Çø„ÉñÂêç„ÇíÁ∑®ÈõÜ'; editBtn.innerHTML = iconEdit();
      editBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); startInlineEdit(chip, tab); }); chip.appendChild(editBtn);

      // delete as X (no confirm)
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='„Çø„Éñ„ÇíÂâäÈô§'; delBtn.innerHTML = iconX();
      delBtn.addEventListener('click',(ev)=>{ ev.stopPropagation(); state.tabs = state.tabs.filter(t=>t.id!==tab.id); if(state.tabs.length===0) state = defaultState(); if(state.activeTabId === tab.id) state.activeTabId = state.tabs[0].id; saveDebounced(); render(); }); chip.appendChild(delBtn);

      tagBar.appendChild(chip);
    });

    const add = document.createElement('button'); add.className='chip add-tag'; add.innerHTML = iconPlus() + ' „Çø„ÉñËøΩÂä†';
    add.addEventListener('click', ()=>{ const name = prompt('Êñ∞„Åó„ÅÑ„Çø„ÉñÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','Êñ∞„Åó„ÅÑ„Éé„Éº„Éà'); if(name===null) return; const t = {id: uid(), name: name.trim()||'„Éé„Éº„Éà', boxes: [ {id: uid(), content: ''} ]}; state.tabs.push(t); state.activeTabId = t.id; saveDebounced(); render(); });
    tagBar.appendChild(add);
  }

  async function copyAllBoxes(tabId){ const tab = state.tabs.find(t=>t.id===tabId); if(!tab) return; const text = tab.boxes.map(b=>b.content||'').join('\n\n'); try{ await navigator.clipboard.writeText(text); }catch(e){ console.error('copy failed', e); } }

  function renderMain(){
    mainArea.innerHTML = ''; const tab = state.tabs.find(t=>t.id===state.activeTabId); if(!tab) return; tab.boxes.forEach((box, idx)=>{
      const card = document.createElement('div'); card.className = 'box-card';
      const toolbar = document.createElement('div'); toolbar.className = 'toolbar';

      // add below: small plus icon only
      const addBelow = document.createElement('button'); addBelow.className='icon-btn small-icon'; addBelow.title='‰∏ã„Å´ËøΩÂä†'; addBelow.innerHTML = iconPlus();
      addBelow.addEventListener('click', ()=>{ const nb = {id: uid(), content: ''}; tab.boxes.splice(idx+1,0,nb); saveDebounced(); render(); focusBox(nb.id); });
      toolbar.appendChild(addBelow);

      // copy single box
      const copyBtn = document.createElement('button'); copyBtn.className='icon-btn'; copyBtn.title='„Åì„ÅÆ„Éú„ÉÉ„ÇØ„Çπ„Çí„Ç≥„Éî„Éº'; copyBtn.innerHTML = iconCopy();
      copyBtn.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(box.content||''); copyBtn.innerHTML = iconCopy() + ' ÂÆå‰∫Ü'; setTimeout(()=>{ copyBtn.innerHTML = iconCopy(); },700); }catch(e){ console.error(e); } });
      toolbar.appendChild(copyBtn);

      // clear content
      const clearBtn = document.createElement('button'); clearBtn.className='icon-btn'; clearBtn.title='„Åì„ÅÆ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÊñáÂ≠ó„Çí„ÇØ„É™„Ç¢'; clearBtn.innerHTML = iconEraser();
      clearBtn.addEventListener('click', ()=>{ box.content = ''; saveDebounced(); render(); });
      toolbar.appendChild(clearBtn);

      // delete box (no confirm)
      const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='„Åì„ÅÆ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂâäÈô§'; delBtn.innerHTML = iconTrash();
      delBtn.addEventListener('click', ()=>{ tab.boxes.splice(idx,1); if(tab.boxes.length===0) tab.boxes.push({id: uid(), content: ''}); saveDebounced(); render(); });
      toolbar.appendChild(delBtn);

      const charCount = document.createElement('div'); charCount.className = 'char-count'; charCount.textContent = `${(box.content||'').length}ÊñáÂ≠ó`;
      toolbar.appendChild(charCount);

      const ta = document.createElement('textarea'); ta.value = box.content || ''; ta.placeholder = '„Åì„Åì„Å´„É°„É¢„ÇíÂÖ•Âäõ'; ta.style.overflow='hidden'; ta.style.resize='none';
      ta.addEventListener('input', (e)=>{ box.content = e.target.value; charCount.textContent = `${e.target.value.length}ÊñáÂ≠ó`; adjustHeight(e.target); saveDebounced(); });

      card.appendChild(toolbar); card.appendChild(ta); mainArea.appendChild(card);
      setTimeout(()=>{ adjustHeight(ta); },0);
    }); }

  function focusBox(id){ setTimeout(()=>{ const tab = state.tabs.find(t=>t.id===state.activeTabId); if(!tab) return; const idx = tab.boxes.findIndex(b=>b.id===id); if(idx<0) return; const textarea = mainArea.querySelectorAll('textarea')[idx]; if(textarea){ textarea.focus(); const v = textarea.value; textarea.value=''; textarea.value=v; adjustHeight(textarea); } },200); }

  function render(){ renderTags(); renderMain(); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  document.addEventListener('keydown', (e)=>{ if(e.key === 'n' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); const name = prompt('Êñ∞„Åó„ÅÑ„Çø„ÉñÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','Êñ∞„Åó„ÅÑ„Éé„Éº„Éà'); if(name===null) return; const t = {id: uid(), name: name.trim()||'„Éé„Éº„Éà', boxes: [ {id: uid(), content: ''} ]}; state.tabs.push(t); state.activeTabId = t.id; saveDebounced(); render(); } });

  load(); if(!state.activeTabId) state.activeTabId = state.tabs[0].id; render(); saveMetaEl.textContent = 'Ë™≠„ÅøËæº„Åø: ' + nowStr();
  setInterval(()=>save(), 30000);
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') save(); });

})();
</script>
</body>
</html>
