<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>スマホ用ローカルメモ（単一HTML）</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f9fafb;       /* 明るいグレー */
      --ink:#111827;         /* 黒 */
      --ink-dim:#6b7280;     /* グレー */
      --accent:#2563eb;      /* 青 */
      --accent-2:#3b82f6;    /* 明るい青 */
      --danger:#dc2626;      /* 赤 */
      --ok:#16a34a;          /* 緑 */
      --tab:#e5e7eb;         /* グレー */
      --tab-active:#ffffff;  /* 白 */
      --border:#d1d5db;      /* グレー */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .app{height:100%; display:flex; flex-direction:column}
    .tabs{
      position:fixed; top:0; left:0; right:0; z-index:10; background:var(--panel);
      padding:8px env(safe-area-inset-right) 8px env(safe-area-inset-left);
      border-bottom:1px solid var(--border);
    }
    .tabbar{display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
    .tabbar::-webkit-scrollbar{display:none}
    .tab{
      flex:0 0 auto; max-width:60vw; padding:8px 12px; border-radius:10px; background:var(--tab); color:var(--ink);
      border:1px solid var(--border); opacity:0.9; display:flex; align-items:center; gap:8px; font-size:14px;
    }
    .tab.active{background:var(--tab-active); border-color:var(--accent); box-shadow:0 0 0 1px var(--accent) inset}
    .tab-title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .tab-actions{display:flex; gap:6px; margin-top:6px}
    .btn{appearance:none; border:none; background:var(--tab); color:var(--ink); padding:10px 12px; border-radius:10px; font-size:14px; border:1px solid var(--border)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent-2); border-color:var(--accent); color:#fff}
    .btn.danger{background:#fef2f2; border-color:var(--danger); color:var(--danger)}

    .editor-wrap{flex:1 1 auto; display:flex}
    .editor{
      width:100%; resize:none; border:none; outline:none; background:transparent; color:var(--ink); font-size:16px; line-height:1.6; padding:16px;
      padding-top: calc(84px + env(safe-area-inset-top));
      padding-bottom: calc(78px + env(safe-area-inset-bottom));
    }

    .toolbar{
      position:fixed; bottom:0; left:0; right:0; z-index:10; background:var(--panel);
      padding:8px env(safe-area-inset-right) 8px env(safe-area-inset-left);
      border-top:1px solid var(--border);
    }
    .tools{display:flex; gap:8px; align-items:center; overflow-x:auto}
    .tools .grow{flex:1}
    .metric{font-size:12px; color:var(--ink-dim)}

    dialog{border:none; border-radius:12px; padding:0; background:var(--panel); color:var(--ink); width:min(92vw,480px)}
    .dialog-body{padding:16px; display:flex; flex-direction:column; gap:12px}
    .input{width:100%; background:#ffffff; border:1px solid var(--border); border-radius:8px; color:var(--ink); padding:12px; font-size:16px}

    @media (min-width:768px){
      .editor{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header class="tabs">
      <div class="tabbar" id="tabbar" aria-label="メモタブ"></div>
      <div class="tab-actions">
        <button class="btn primary" id="addTabBtn">＋ タブ追加</button>
        <button class="btn" id="renameTabBtn">名前変更</button>
        <button class="btn danger" id="deleteTabBtn">タブ削除</button>
      </div>
    </header>

    <main class="editor-wrap">
      <textarea id="editor" class="editor" placeholder="ここにメモを書きます。すべて端末内（ローカルストレージ）に保存されます。"></textarea>
    </main>

    <footer class="toolbar">
      <div class="tools">
        <button class="btn" id="copyBtn">コピー</button>
        <button class="btn" id="clearBtn">クリア</button>
        <div class="grow"></div>
        <div class="metric" id="countAll">全体: 0 文字</div>
        <div class="metric" id="countSel" style="margin-left:8px">選択: 0 文字</div>
      </div>
    </footer>
  </div>

  <dialog id="titleDialog">
    <form method="dialog" class="dialog-body" id="titleForm">
      <label for="titleInput">タブ名</label>
      <input id="titleInput" class="input" type="text" inputmode="text" autocomplete="off" />
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" value="cancel">キャンセル</button>
        <button class="btn primary" value="ok">OK</button>
      </div>
    </form>
  </dialog>

  <script>
  // JS部分はそのまま（デザインのみ変更）
  ;(() => {
    const LS_KEY = 'local-memo-tabs-v1';
    let state = load() || createInitialState();
    let saveTimer = null;

    const $ = (sel) => document.querySelector(sel);
    const tabbar = $('#tabbar');
    const editor = $('#editor');
    const dTitle = $('#titleDialog');
    const titleInput = $('#titleInput');

    const btnAdd = $('#addTabBtn');
    const btnRename = $('#renameTabBtn');
    const btnDelete = $('#deleteTabBtn');
    const btnCopy = $('#copyBtn');
    const btnClear = $('#clearBtn');

    const $countAll = $('#countAll');
    const $countSel = $('#countSel');

    renderTabs();
    openActiveTab();
    updateCounts();

    btnAdd.addEventListener('click', async () => {
      const id = crypto.randomUUID();
      const idx = state.tabs.length + 1;
      const title = `メモ ${idx}`;
      state.tabs.push({ id, title, content: '', updatedAt: Date.now() });
      state.activeId = id;
      persist();
      renderTabs();
      openActiveTab();
      await showTitleDialog('タブ名の入力', title);
    });

    btnRename.addEventListener('click', async () => {
      const tab = getActive();
      if (!tab) return;
      const newTitle = await showTitleDialog('タブ名の変更', tab.title);
      if (newTitle != null) {
        tab.title = newTitle.trim() || tab.title;
        tab.updatedAt = Date.now();
        persist();
        renderTabs();
      }
    });

    btnDelete.addEventListener('click', () => {
      const tab = getActive();
      if (!tab) return;
      if (!confirm(`「${tab.title}」を削除します。よろしいですか？`)) return;
      const idx = state.tabs.findIndex(t => t.id === tab.id);
      state.tabs.splice(idx, 1);
      if (state.tabs.length === 0) {
        Object.assign(state, createInitialState());
      } else {
        const next = state.tabs[Math.max(0, idx - 1)];
        state.activeId = next.id;
      }
      persist();
      renderTabs();
      openActiveTab();
    });

    btnCopy.addEventListener('click', async () => {
      try {
        const text = editor.value;
        await navigator.clipboard.writeText(text);
        flash(btnCopy, 'コピーしました');
      } catch (e) {
        editor.select();
        document.execCommand('copy');
        flash(btnCopy, 'コピーしました');
      }
    });

    btnClear.addEventListener('click', () => {
      if (!editor.value) return;
      if (!confirm('このタブの内容をすべて消去します。よろしいですか？')) return;
      editor.value = '';
      writeBack();
      updateCounts();
      flash(btnClear, 'クリアしました');
    });

    editor.addEventListener('input', () => { writeBack(); updateCounts(); });
    editor.addEventListener('select', updateCounts);
    editor.addEventListener('keyup', updateCounts);
    editor.addEventListener('mouseup', updateCounts);

    window.addEventListener('beforeunload', () => persist(true));

    function createInitialState(){
      const id = crypto.randomUUID();
      return {
        tabs: [{ id, title: 'メモ 1', content: '', updatedAt: Date.now() }],
        activeId: id
      };
    }

    function load(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null }
    }

    function persist(immediate=false){
      const doSave = () => localStorage.setItem(LS_KEY, JSON.stringify(state));
      if (immediate){ doSave(); return; }
      clearTimeout(saveTimer);
      saveTimer = setTimeout(doSave, 250);
    }

    function getActive(){
      return state.tabs.find(t => t.id === state.activeId);
    }

    function openActiveTab(){
      const tab = getActive();
      if (!tab) return;
      editor.value = tab.content || '';
      editor.focus({ preventScroll:true });
      editor.setSelectionRange(editor.value.length, editor.value.length);
      updateCounts();
    }

    function writeBack(){
      const tab = getActive();
      if (!tab) return;
      tab.content = editor.value;
      tab.updatedAt = Date.now();
      persist();
      renderTabs();
    }

    function renderTabs(){
      tabbar.innerHTML = '';
      for(const t of state.tabs){
        const el = document.createElement('div');
        el.className = 'tab' + (t.id === state.activeId ? ' active' : '');
        el.role = 'button';
        el.tabIndex = 0;
        el.innerHTML = `<span class="tab-title">${escapeHtml(t.title)}</span>`;
        el.addEventListener('click', () => { state.activeId = t.id; persist(); renderTabs(); openActiveTab(); });
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ el.click(); }});
        tabbar.appendChild(el);
      }
    }

    function updateCounts(){
      const v = editor.value || '';
      const len = [...v].length;
      $countAll.textContent = `全体: ${len} 文字`;
      const sel = editor.selectionEnd - editor.selectionStart;
      const selLen = Math.max(0, sel);
      $countSel.textContent = `選択: ${selLen} 文字`;
    }

    function flash(btn, text){
      const old = btn.textContent;
      btn.textContent = text;
      btn.disabled = true;
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 900);
    }

    function showTitleDialog(titleText, current){
      return new Promise((resolve)=>{
        $('#titleForm').reset();
        titleInput.value = current || '';
        dTitle.returnValue = 'cancel';
        dTitle.showModal();
        setTimeout(()=>{ titleInput.focus(); titleInput.select(); }, 0);
        dTitle.addEventListener('close', onClose, { once:true });
        function onClose(){
          if (dTitle.returnValue === 'ok') {
            resolve(titleInput.value);
          } else {
            resolve(null);
          }
        }
      });
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
  })();
  </script>
</body>
</html>
